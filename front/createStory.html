<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=yes">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <link rel="stylesheet" href="storyStyle.css">
    <title>CreateStory</title>
  </head>

  <body class="container" text-center>
    <h1 id="header" class="text-center display-3" contenteditable="true"><b>Story Title</b></h1>

    <div id="subheader">
      <h3 id="summary" class="text-center" contenteditable="true">Summary</h3>
    </div>

    <div id="chapterOptions" width="100%" class="mt-3">
      <h3 id="chapter_title" class="text-center float-left" contenteditable="true">Chapter Title</h3>
      <select id="chapterSelector"class="btn" background-color="#222426">
        <option value="" selected="true">Chapters</option>
      </select>
      <button id="chapterAdd"  type="click" class="btn btn-secondary float-right" >Add Chapter</button>
      <button id="chapterSave" type="click" class="btn btn-secondary float-right" >Save Chapter</button>
    </div>

    <main id="page" class="mb-5">
      <div id = "Chapter">
        <div id="currentChapter" contenteditable="true" overflow="auto"></div>
      </div>
    </main>

    <footer class="bg-dark fixed-bottom p-2">
      <a href="/" class="text-white float-left">Back to Archive</a>
    </footer>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script>
    const id = new URLSearchParams(window.location.search).get('id');
      // get the story by the id
      if (id) {
        $.ajax({method: 'GET', url: '/user'})
          .done(function(user) {
        if (user) {
          $.ajax({method: 'GET', url: `/stories/${id}`})
          .done(function(story){
            for (var i = 0; i < story.chapters.length; i++) {
              const selector = document.getElementById('chapterSelector');
              var x = selector.options.length;
              const option = document.createElement('option');
              option.value = option.text = ("Chapter"+" "+x);
              selector.add(option)
              $('#header').text(story.title);
              $('#summary').text(story.summary);
            }

          });

          // can manually add new chapters
          $('#chapterAdd').on('click', function() {
            const selector = document.getElementById('chapterSelector');
            var x = selector.options.length;
            const option = document.createElement('option');
            option.value = option.text = ("Chapter"+" "+x);
            selector.add(option)
          });

          // when a chapter is selected change the text box to the database.array[x] text
          $('#chapterSelector').on('change', function(){
            const selector = $(this);
            $.ajax({method: 'GET', url: `/stories/${id}`})
            .done(function(story){
              if(story)
                var x = selector.prop("selectedIndex");
                const chapterText = story.chapters[x-1].text;
                const chapterTitle = story.chapters[x-1].title;
              const text = chapterText.replace(/^\s+/mg, "<br/>");
              $('#currentChapter').append('<pre>' + text + '</pre>');
              $('#chapter_title').text(chapterTitle);


              });
          });

          //when the save chapter button is clicked save the new updated text to db
          $('#chapterSave').on('click', function(){
            const updatedText = $('#Chapter').text().trim().replace(/\n/g, "<br/><br/>"); //get the current updated text
            const chapterTitle = $('#chapter_title').text(); // get the curent chapter text
            const chapterIndex = $('#chapterSelector').prop("selectedIndex") -1; // get the chapter
            const storyTitle = $('#header').text();
            const summary_text = $('#summary').text();
            const updatebody = {
              index: chapterIndex,
              text: updatedText,
              chapter_title: chapterTitle,
              story_title: storyTitle,
              summary: summary_text
            };
            $.ajax({method: 'PATCH', url: `/stories/${id}`, data: updatebody})
              .fail(function() {
                alert("Could not update story!");
              })
              .done(function() {
                location.reload();
              });
            });
          } else {
            alert('Could not get story. User must be logged in to edit.');
          }
        });
      } else {  // they're making a new story
      $.ajax({method: 'GET', url: '/user'})
        .done(function(user) {
          if (user) {  // make sure they're logged in
            // we'll only let them start with one chapter for a new story
            $('#chapterAdd').remove();
            $('#chapterSelector').remove();
          }
        });
      }
    </script>
  </body>
</html>
