<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=yes">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-tagsinput/0.8.0/bootstrap-tagsinput.css">
    <link rel="stylesheet" href="style.css">
    <title>Create Story</title>
  </head>

  <body id="pageBody" class="container" text-center>
    <h1 id="creatorHeader" class="text-center display-3" contenteditable="true"><b>Story Title</b></h1>

    <div id="subheader">
      <h3>Summary</h3>
      <input id="summary" type="text"></input>
      <p id="successText"></p>
    </div>

    <div>
      <h4>Story Genres</h4>
      <input id="tags" type="text" value="" data-role="tagsinput" class="form-control"></input>
    </div>

    <div id="chapterOptions" width="100%" class="mt-3">
      <input id="chapter_title" class="text-center float-left" contenteditable="true" value="Chapter Title"></input>
    </div>

    <main id="page" class="mb-5">
      <div id="Chapter">
        <div id="currentChapter" contenteditable="true" overflow="auto"></div>
        <button id="publish" class="btn btn-primary">Publish</button>
      </div>
    </main>

    <footer class="bg-dark fixed-bottom p-2">
      <a href="/" class="text-white float-left">Back to Archive</a>
    </footer>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-tagsinput/0.8.0/bootstrap-tagsinput.min.js"></script>
    <script>
    const id = new URLSearchParams(window.location.search).get('id');
    const success = new URLSearchParams(window.location.search).get('success');
      // get the story by the id
      if (id) {
        if (success) {
          $("#successText").text("Successfully submitted story.");
        }
        $('#chapterOptions').append('<select id="chapterSelector" class="btn" background-color="#222426"><option value="" selected="true">Chapter 1</option></select><button id="chapterAdd" type="click" class="float-right btn btn-primary" >Add Chapter</button>');
        $.ajax({method: 'GET', url: '/user'})
          .done(function(user) {
        if (user) {
          $.ajax({method: 'GET', url: `/stories/${id}`})
          .done(function(story){
            $('#creatorHeader').text(story.title);
            $('#summary').val(story.summary);
            const chapterText = story.chapters[0].text;
            const chapterTitle = story.chapters[0].title;
            const text = chapterText.replace(/^\s+/mg, "<br/>");
            $('#currentChapter').html('<pre>' + text + '</pre>');
            $('#chapter_title').val(chapterTitle);
            for (tag of story.tags) {
              $('#tags').tagsinput('add', tag);
            }
            for (var i = 1; i < story.chapters.length; i++) {
              const selector = document.getElementById('chapterSelector');
              var x = selector.options.length + 1;
              const option = document.createElement('option');
              option.value = option.text = ("Chapter"+" "+x);
              selector.add(option)
            }
          });

          // can manually add new chapters
          $('#chapterAdd').on('click', function() {
            const selector = document.getElementById('chapterSelector');
            var x = selector.options.length + 1;
            const option = document.createElement('option');
            option.value = option.text = ("Chapter"+" "+x);
            selector.add(option)
          });

          // when a chapter is selected change the text box to the database.array[x] text
          $('#chapterSelector').on('change', function(){
            const selector = $(this);
            $.ajax({method: 'GET', url: `/stories/${id}`})
            .done(function(story){
              var x = selector.prop("selectedIndex") + 1;
              const chapterText = story.chapters[x-1].text;
              const chapterTitle = story.chapters[x-1].title;
              const text = chapterText.replace(/^\s+/mg, "<br/>");
              $('#currentChapter').html('<pre>' + text + '</pre>');
              $('#chapter_title').val(chapterTitle);

              });
          });

          // when the publish button is clicked, save the new updated text to db
          $('#publish').on('click', function(){
            const updatedText = $('#currentChapter').text().trim().replace(/\n/g, "<br/><br/>"); // get the current updated text
            const chapterTitle = $('#chapter_title').val(); // get the curent chapter text
            const chapterIndex = $('#chapterSelector').prop("selectedIndex"); // get the chapter
            const storyTitle = $('#creatorHeader').text();
            const summary_text = $('#summary').val();
            const tags_list = $("#tags").tagsinput('items');
            const updatebody = {
              index: chapterIndex,
              text: updatedText,
              chapter_title: chapterTitle,
              story_title: storyTitle,
              summary: summary_text,
              tags: tags_list
            };
            $.ajax({method: 'PATCH', url: `/stories/${id}`, data: updatebody})
              .fail(function() {
                alert("Could not update story!");
              })
              .done(function() {
                $(location).attr('href', `createStory?id=${id}&success=true`);
              });
            });
          } else {
            alert('Could not get story. User must be logged in to edit.');
          }
        });
      } else {  // they're making a new story
      $.ajax({method: 'GET', url: '/user'})
        .done(function(user) {
          if (user) {  // make sure they're logged in
            // we'll only let them start with one chapter for a new story
            $('#chapterAdd').remove();
            $('#chapterSelector').remove();

            // when the publish button is clicked save the new updated text to db
            $('#publish').on('click', function(){
              const updatedText = $('#currentChapter').text().trim().replace(/\n/g, "<br/><br/>"); // get the current updated text
              const chapterTitle = $('#chapter_title').val(); // get the curent chapter text
              const storyTitle = $('#creatorHeader').text();
              const summary_text = $('#summary').val();
              const tags_list = $('#tags').tagsinput('items');
              const updatebody = {
                text: updatedText,
                chapter_title: chapterTitle,
                story_title: storyTitle,
                summary: summary_text,
                user: user,
                tags: tags_list
              };
              $.ajax({method: 'POST', url: `/stories`, data: updatebody})
                .fail(function() {
                  alert("Could not post story!");
                })
                .done(function(story) {
                  $.ajax({method: 'PATCH', url: `/profiles/${user.id}`, data: {story: story._id, user: user.id, name: user.name}})
                    .fail(function() {
                      alert("Could not post story!");
                    })
                    .done(function() {
                      $("#successText").text("Successfully updated story.");
                    });
                });
              });
          } else {
            alert('User must be logged in to post a story.');
          }
        });
      }
    </script>
  </body>
</html>
